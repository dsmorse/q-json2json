/*! q-json2json 02-06-2015 */
(function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=("function"==typeof require?require("sysmo"):void 0)||("undefined"!=typeof window&&null!==window?window.Sysmo:void 0),a=function(){function a(a){this.applyFormatting=c(this.applyFormatting,this),this.aggregate=c(this.aggregate,this),this.processable=c(this.processable,this),this.getValue=c(this.getValue,this),this.getKey=c(this.getKey,this),this.getPath=c(this.getPath,this),a.path||(a.path="."),a.as||(a.as={}),b.isString(a.choose)&&(a.choose=[a.choose]),b.isString(a.include)&&(a.include=[a.include]),this.arrayToMap=!!a.key,this.mapToArray=!this.arrayToMap&&a.key===!1&&!a.as,this.directMap=!(!this.arrayToMap||!a.value),this.nestTemplate=!!a.nested,this.includeAll=!!a.all,this.config=a}return a.prototype.getPath=function(){return this.config.path},a.prototype.getKey=function(a){switch(b.type(this.config.key)){case"Function":return{name:"value",value:this.config.key(a)};default:return{name:"path",value:this.config.key}}},a.prototype.getValue=function(a,c){switch(b.type(this.config.value)){case"Function":return{name:"value",value:this.config.value(a)};case"String":return{name:"path",value:this.config.value};default:return{name:"template",value:this.config.as}}},a.prototype.processable=function(a,c,d){var e,f,g,h,i;if(!this.config.choose&&this.includeAll)return!0;if(!this.config.choose&&!this.paths){this.paths=[],i=this.config.as;for(d in i)c=i[d],b.isString(c)&&this.paths.push(c.split(".")[0])}if(b.isArray(this.config.choose)){for(h=this.paths||[],h=h.concat(this.config.choose),e=0,f=h.length;f>e;e++)if(g=h[e],g.split(".")[0]===d)return!0;return!1}return b.isFunction(this.config.choose)?!!this.config.choose.call(this,a,c,d):!(!this.includeAll&&!this.directMap)},a.prototype.aggregate=function(a,c,d,e){var f,g;return f=(null!=(g=this.config.aggregate)?g[c]:void 0)||this.config.aggregate,b.isFunction(f)?(a[c]=f(c,d,e),!0):!1},a.prototype.applyFormatting=function(a,c,d){var e,f,g;return b.isNumber(d)?f={}:(e=(null!=(g=this.config.format)?g[d]:void 0)||this.config.format,f=b.isFunction(e)?e(a,c,d):{}),Q.isPromise(f)||(f=Q(f)),f.then(function(a){return"key"in a||(a.key=d),"value"in a||(a.value=c),Q.isPromise(a.value)||(a.value=Q(a.value)),a.value.then(function(b){return a.value=b,a})})},a}(),"undefined"!=typeof module&&null!==module?module.exports=a:(window.json2json||(window.json2json={}),window.json2json.TemplateConfig=a)}).call(this),function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}},e=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};c=("function"==typeof require?require("sysmo"):void 0)||("undefined"!=typeof window&&null!==window?window.Sysmo:void 0),b=("function"==typeof require?require("./TemplateConfig"):void 0)||("undefined"!=typeof window&&null!==window?window.json2json.TemplateConfig:void 0),a=function(){function a(a,c){this.paths=d(this.paths,this),this.pathAccessed=d(this.pathAccessed,this),this.getNode=d(this.getNode,this),this.nodeToProcess=d(this.nodeToProcess,this),this.aggregateValue=d(this.aggregateValue,this),this.updateContext=d(this.updateContext,this),this.processRemaining=d(this.processRemaining,this),this.processTemplate=d(this.processTemplate,this),this.chooseValue=d(this.chooseValue,this),this.chooseKey=d(this.chooseKey,this),this.createMapStructure=d(this.createMapStructure,this),this.processMap=d(this.processMap,this),this.processArray=d(this.processArray,this),this.transform=d(this.transform,this),this.config=new b(a),this.parent=c}return a.prototype.transform=function(a){var b;if(b=this.nodeToProcess(a),null==b)return Q(null);switch(c.type(b)){case"Array":return this.processArray(b);case"Object":return this.processMap(b);default:return Q(null)}},a.prototype.processArray=function(a){var b,c,d;return b=this.config.arrayToMap?{}:[],function(){var b,e,f;for(f=[],d=b=0,e=a.length;e>b;d=++b)c=a[d],f.push([c,d]);return f}().reduce(function(a){return function(c,d){var e,f;return e=d[0],f=d[1],c.then(function(){var c;return c=a.config.arrayToMap?a.chooseKey(e):f,a.createMapStructure(e).then(function(d){return a.updateContext(b,e,d,c)})})}}(this),Q(b))},a.prototype.processMap=function(a){return this.createMapStructure(a).then(function(b){return function(c){var d,e;return b.config.nestTemplate&&(e=b.chooseKey(a))&&(d={},d[e]=c,c=d),c}}(this))},a.prototype.createMapStructure=function(a){var b,c,d;return b={},this.config.nestTemplate?function(){var b;b=[];for(c in a)d=a[c],b.push([c,d]);return b}().reduce(function(c){return function(d,e){var f,g;return f=e[0],g=e[1],d.then(function(){var d;return c.config.processable(a,g,f)?(d=c.getNode(a,f),c.chooseValue(d).then(function(a){return c.updateContext(b,d,a,f)})):b})}}(this),Q(b)):this.chooseValue(a,b)},a.prototype.chooseKey=function(a){var b;switch(b=this.config.getKey(a),b.name){case"value":return b.value;case"path":return this.getNode(a,b.value);default:return null}},a.prototype.chooseValue=function(a,b){var c;switch(null==b&&(b={}),c=this.config.getValue(a),c.name){case"value":return Q(c.value);case"path":return Q(this.getNode(a,c.value));case"template":return this.processTemplate(a,b,c.value);default:return Q(null)}},a.prototype.processTemplate=function(a,b,d){var e,f,g;return null==d&&(d={}),e=function(){var a;a=[];for(f in d)g=d[f],a.push([f,g]);return a}().reduce(function(d){return function(e,f){var g,h;return g=f[0],h=f[1],e.then(function(){var e;switch(c.type(h)){case"String":e=function(a,b){return d.getNode(a,b)};break;case"Array":e=function(a,b){var c,e,f,g;for(g=[],c=0,e=b.length;e>c;c++)f=b[c],g.push(d.getNode(a,f));return g};break;case"Function":e=function(a,b){return b.call(d,a,g)};break;case"Object":e=function(a,b){return new d.constructor(b,d).transform(a)};break;default:e=function(a,b){return b}}return h=e(a,h),d.updateContext(b,a,h,g)})}}(this),Q(b)),e.then(function(c){return function(){return c.processRemaining(b,a)}}(this))},a.prototype.processRemaining=function(a,b){var c,d;return function(){var a;a=[];for(c in b)d=b[c],a.push([c,d]);return a}().reduce(function(c){return function(d,f){var g,h;return g=f[0],h=f[1],d.then(function(){return c.pathAccessed(b,g)||e.call(a,g)>=0||!c.config.processable(b,h,g)?a:c.updateContext(a,b,h,g)})}}(this),Q(a))},a.prototype.updateContext=function(a,b,c,d){return this.config.applyFormatting(b,c,d).then(function(b){return function(c){return b.aggregateValue(a,c.key,c.value)}}(this))},a.prototype.aggregateValue=function(a,b,d){var e;return null==d?a:c.isArray(a)?(a.push(d),a):(e=a[b],this.config.aggregate(a,b,d,e)?a:(null==e?a[b]=d:c.isArray(e)?a[b].push(d):a[b]=[e,d],a))},a.prototype.nodeToProcess=function(a){return this.getNode(a,this.config.getPath())},a.prototype.getNode=function(a,b){return b?"."===b?a:(this.paths(a,b),c.getDeepValue(a,b,!0)):null},a.prototype.pathAccessed=function(a,b){var c;return c=b.split(".")[0],-1!==this.paths(a).indexOf(c)},a.prototype.paths=function(a,b){var c,d;return b&&(b=b.split(".")[0]),this.pathNodes||(this.pathNodes=this.parent&&this.parent.pathNodes||[]),this.pathCache||(this.pathCache=this.parent&&this.parent.pathCache||[]),c=this.pathNodes.indexOf(a),b?(-1===c?(d=[],this.pathNodes.push(a),this.pathCache.push(d)):d=this.pathCache[c],b&&-1===d.indexOf(b)&&d.push(b),d):-1!==c?this.pathCache[c]:[]},a}(),"undefined"!=typeof module&&null!==module?module.exports=a:(window.json2json||(window.json2json={}),window.json2json.ObjectTemplate=a)}.call(this),function(a){var b={stub:function(){},makeArray:function(a){return Array.prototype.slice.call(a)},type:function(a){return Object.prototype.toString.call(a).match(/(\S+)\]$/)[1]},isType:function(a,c){return b.type(a)==c},isArray:function(a){return b.isType(a,"Array")},isArrayLike:function(a){return!!a&&(b.isArray(a)||a.hasOwnProperty("length")&&b.makeArray(a).length)},isFunction:function(a){return b.isType(a,"Function")},isPlainObject:function(a){return b.isType(a,"Object")&&a.constructor===Object},isObject:function(a){return!!a&&!b.isArray(a)&&"object"==typeof a},isNumber:function(a){return b.isType(a,"Number")},isString:function(a){return b.isType(a,"String")},isNumeric:function(a){return Number(a)+""==a+""},isUndefined:function(a){return void 0===a},isNull:function(a){return null===a},extend:function(a,c,d){a=a||{};for(var e in c){var f=c[e];e in a?d&&b.isObject(f)&&(null==a[e]||b.isObject(a[e]))&&b.extend(a[e]||{},f,d):a[e]=d?null==f||b.isObject(f)?b.extend({},f):b.isArray(f)?f.slice(0):f:f}return a},include:function(a,c,d){return"string"==typeof a&&(d=c,c=a,a=b),b.namespace(c,a),a=b.getDeepValue(a,c),b.extend(a,d)},namespace:function(a,b){b=b||{};for(var c=a.split("."),d=b,e=0;e<c.length;e++){var f=c[e];d=f in d?d[f]:d[f]={}}return b},getDeepValue:function(a,c,d){if(d&&b.isArrayLike(a)){a=b.makeArray(a);for(var e=[],f=0;f<a.length;f++){var g=b.getDeepValue(a[f],c,d);if("undefined"!=typeof g)if(b.isArray(g))for(var h=0;h<g.length;h++)e.push(g[h]);else e.push(g)}return e.length?e:void 0}var i=/\(\)$/,j=c.split(".");if(null!=a&&j.length){var k=j.shift(),l=i.test(k);l&&(k=k.replace(i,"")),a=l&&k in a?a[k]():a[k],c=j.join("."),c&&(a=b.getDeepValue(a,c,d))}return a},formatString:function(a,c){return c=c.constructor!==Array?b.makeArray(arguments).splice(1):c,a.replace(/\{(\d+)\}/g,function(a,b){return c[b]})},steps:function(a){var c=b.makeArray(arguments),d=function(){var e=b.makeArray(arguments),f=c.shift();e.unshift(d),f.apply(a,e)};/^function/i.test(a)?a=this:c.shift(),c.length&&d()},arrangeArgs:function(){var a=b.makeArray(arguments),c=b.makeArray(a.shift()),d=a.pop(),e=[],f=function(){return e.length||(e=Array(a.length)),d.apply(null,e.concat(c))};if(!c.length)return f();for(var g=0;g<a.length;g++){var h=a[g];if(c.length){var i=h[0]||h,j=h[1]?i:function(a){return a.constructor===i};if(j(c[0])){e.push(c.shift());continue}}e.push(h[2])}return f()}};"undefined"!=typeof module&&null!==module?module.exports=b:window.Sysmo=b}();